<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dynamic CRUD</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</head>
<style>
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1050;
    }

    #order-items-container {
    height: 300px;
    overflow-y: auto;
    border: 1px solid #ccc;
    padding: 10px;
    }

    #order-items-container .table {
        width: 100%;
        margin-bottom: 0;
    }

    #order-items-container .table td, #order-items-container .table th {
        padding: 8px;
        vertical-align: middle;
    }
</style>
<body>
    <div class="container">
        <h1 id="crud-title"></h1>
        <button id="create-product-btn" class="btn btn-success mt-3">Create</button>
        <div id="error-messages"></div>

        <!-- Form to input filters -->
        <form id="crud-form">
            <!-- Dynamic form fields will be injected here from the json-->
        </form>
        <button id="submit-btn" class="btn btn-primary">Filter</button>

        <!-- Table to display entities -->
        <table class="table table-bordered mt-4" id="entities-table" style="display: none;">

            <thead>
                <tr id="table-headers">
                    <!-- Dynamic headers will be injected here -->
                </tr>
            </thead>

            <tbody id="entities-tbody">
                <!-- Dynamic rows will be injected here -->
            </tbody>

        </table>
        <div id="loading-overlay" class="d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Bootstrap Modal for editing an entity -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">

            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Entity</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body">

                    <form id="edit-form">
                        <!-- Dynamic form fields for editing will be injected here -->
                    </form>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="save-edit-btn">Save changes</button>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal for creating a new product -->
    <div class="modal fade" id="createProductModal" tabindex="-1" role="dialog" aria-labelledby="createProductModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="createProductModalLabel">Create New</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body">
                    <form id="create-product-form">
                        <!-- Dynamic form fields for product creation will be injected here -->
                    </form>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="save-create-product-btn">Create</button>
                </div>
            </div>
        </div>
    </div>
    <script  defer src="/ajv.js" type="module"></script>

    <script>
        let validate;
        let currentSchema;

        document.addEventListener('DOMContentLoaded', async () => {
            const Ajv = window.Ajv;
            const ajv = new Ajv({ allErrors: true, strict: false });
            window.ajvErrors(ajv);

            let schema = await fetch(`/${entityType}_validation_schema.json`);
            currentSchema = await schema.json();
            console.log("currentSchema");
            console.log(currentSchema);
            validate = ajv.compile(currentSchema);
        });

        // Function to get the entity type from the URL (e.g., ?products or ?users)
        function getEntityTypeFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('entity');  // Get the value after ?entity=
        }

        // Set the entity type dynamically based on the URL
        const entityType = getEntityTypeFromUrl();

        // Load the schema dynamically based on the entity type
        async function loadSchema(entity) {
            try {
                console.log("entityType");
                console.log(entityType);
                const response = await fetch(`${entity}.json`);
                const schema = await response.json();
                console.log('Schema loaded:', schema);
                return schema;
            } catch (error) {
                console.error('Error loading schema:', error);
                return null;
            }
        }

        // Render form based on the schema
        function renderForm(schema) {
            const form = document.getElementById('crud-form');
            const title = document.getElementById('crud-title');
            title.textContent = `Manage ${entityType}`;

            schema.fields.forEach(field => {
                if (!field.show_in_filter) return; // Skip non-editable or non-filter fields

                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = field.label;
                formGroup.appendChild(label);

                let input;

                if (field.type === 'date') {
                    const dateFromGroup = document.createElement('div');
                    dateFromGroup.className = 'form-group';
                    
                    const dateFromLabel = document.createElement('label');
                    dateFromLabel.textContent = `${field.label} From`;
                    dateFromGroup.appendChild(dateFromLabel);
                    
                    const dateFromInput = document.createElement('input');
                    dateFromInput.type = 'date';
                    dateFromInput.className = 'form-control';
                    dateFromInput.name = `${field.name}_from`;
                    dateFromGroup.appendChild(dateFromInput);
                    form.appendChild(dateFromGroup);

                    const dateToGroup = document.createElement('div');
                    dateToGroup.className = 'form-group';

                    const dateToLabel = document.createElement('label');
                    dateToLabel.textContent = `${field.label} To`;
                    dateToGroup.appendChild(dateToLabel);

                    const dateToInput = document.createElement('input');
                    dateToInput.type = 'date';
                    dateToInput.className = 'form-control';
                    dateToInput.name = `${field.name}_to`;
                    dateToGroup.appendChild(dateToInput);
                    form.appendChild(dateToGroup);

                    return;

                } else if (field.type === 'multiselect') {
                    input = document.createElement('select');
                    input.className = 'form-control';
                    input.name = field.name;
                    input.multiple = true;

                    // Fetch options from the server for categories
                    fetch(field.options_url)
                        .then(response => response.json())
                        .then(options => {
                            options.forEach(option => {
                                const opt = document.createElement('option');
                                opt.value = option.id;  // Assuming categories are fetched with id and name
                                opt.textContent = option.name;
                                input.appendChild(opt);
                            });
                        })
                        .catch(error => {
                            console.error(`Error loading ${field.name} options:`, error);
                        });
                } else if (field.type === 'image') {
                    // Create an image element
                    input = document.createElement('img');
                    input.className = 'form-image';
                    input.src = `/images/${field.value}`;
                    input.alt = 'Image Preview';
                    input.style.maxWidth = '50px';
                    input.style.height = 'auto';

                } else if (field.type === 'select') {
                    input = document.createElement('select');
                    input.className = 'form-control';
                    input.name = field.name;

                    // Fetch options from the server
                    fetch(field.options_url)
                        .then(response => response.json())
                        .then(options => {
                            options.forEach(option => {
                                const opt = document.createElement('option');
                                opt.value = option.name;
                                opt.textContent = option.name;
                                input.appendChild(opt);
                            });
                        })
                        .catch(error => {
                            console.error(`Error loading ${field.name} options:`, error);
                        });
                } else if (field.type === 'number' || field.type === 'integer') {
                    input = document.createElement('input');
                    input.type = 'number';
                } else if (field.type === 'boolean') {
                    input = document.createElement('input');
                    input.type = 'checkbox';
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                }

                input.className = 'form-control';
                input.name = field.name;
                formGroup.appendChild(input);

                form.appendChild(formGroup);
            });
        }

        // Handle form submission
        async function handleSubmit(event) {
            event.preventDefault();
            console.log('Form submitted');

            const formData = new FormData(document.getElementById('crud-form'));

            console.log("formData");
            console.log(formData);

            const data = {};
            const filters = {};  // Object to hold filter criteria
            filters['schema'] = currentSchema;

            formData.forEach((value, key) => {

                console.log("value");
                console.log(value);
                console.log("key");
                console.log(key);


                // Add non-empty fields to the filters object
                if (value) {
                    // Special case for multiselect fields (categories in this case)
                    if (key === 'categories') {
                        filters[key] = [...formData.getAll(key)]; // Get all selected categories
                    } else {
                        filters[key] = value;
                    }
                }
            });

            console.log("data");
            console.log(data);

            console.log("filters");
            console.log(filters);

            showLoadingSpinner();

            // Fetch filtered products from the back-end
            try {
                const response = await fetch(`/crud/${entityType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(filters),
                });

                const entities = await response.json();

                console.log("entities");
                console.log(entities);

                renderEntityTable(entities);  // Render the filtered entities
            } catch (error) {
                console.error('Error submitting form:', error);
            } finally {
                hideLoadingSpinner();
            }
        }

        // Render the entities table
        function renderEntityTable(entities) {
            console.log("entities in renderEntityTable");
            console.log(entities);

            const table = document.getElementById('entities-table');
            const tbody = document.getElementById('entities-tbody');
            const tableHeaders = document.getElementById('table-headers');

            tbody.innerHTML = '';  // Clear existing rows
            tableHeaders.innerHTML = '';  // Clear existing headers

            if (entities.length === 0) {
                alert('No results found');
                return;
            }

            // Generate headers dynamically based on schema
            const schemaFields = entities[0] ? Object.keys(entities[0]) : [];
            schemaFields.forEach(field => {
                const th = document.createElement('th');
                th.textContent = field.charAt(0).toUpperCase() + field.slice(1);
                th.style.textAlign = 'center';
                tableHeaders.appendChild(th);
            });

            // Add "Options" column for Edit/Delete buttons
            const optionsTh = document.createElement('th');
            optionsTh.textContent = 'Options';
            tableHeaders.appendChild(optionsTh);

            // Generate rows dynamically
            entities.forEach(entity => {
                const row = document.createElement('tr');

                schemaFields.forEach(field => {
                    const cell = document.createElement('td');
                    cell.style.textAlign = 'right';

                    if (field === 'order_items') {
                        const button = document.createElement('button');
                        button.textContent = 'Show Items';
                        button.className = 'btn btn-info btn-sm';

                        button.onclick = async () => {
                            await fetchOrderItems(entity.order_id, cell);
                        };

                        cell.appendChild(button);
                    } else if (field === 'images') {
                        // Handle the array of images
                        const images = entity[field];  // Array of image paths
                        console.log("entity[field]");
                        console.log(entity[field]);
                        images.forEach(imagePath => {
                            console.log("imagePath");
                            console.log(imagePath);
                            const img = document.createElement('img');
                            img.src = `/${imagePath}`;
                            img.style.maxWidth = '100px';
                            img.style.height = 'auto';
                            cell.appendChild(img);
                        });
                    } else {
                        // For other fields, simply set the text content
                        cell.textContent = entity[field];
                    }

                    row.appendChild(cell);
                });

                // Add Edit/Delete buttons
                const optionsCell = document.createElement('td');

                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-warning btn-sm';
                editBtn.textContent = 'Edit';
                if (entityType == 'orders') {
                    console.log("entity.order_id");
                    console.log(entity.order_id);
                    editBtn.onclick = () => editEntity(entity, entity.order_id);  // Call edit function
                } else {
                    editBtn.onclick = () => editEntity(entity, entity.id);  // Call edit function
                }

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteEntity(entity.id);  // Call delete function

                optionsCell.appendChild(editBtn);
                optionsCell.appendChild(deleteBtn);
                row.appendChild(optionsCell);

                tbody.appendChild(row);
            });

            table.style.display = 'table';  // Show the table
        }

        // Edit Entity function: Opens the modal and populates the form with current entity data
        async function editEntity(entity, id) {
            const modal = document.getElementById('editModal');
            const editForm = document.getElementById('edit-form');
            editForm.innerHTML = ''; 

            const filters = {};
            filters['schema'] = currentSchema;
            if (entityType == 'orders') {
                filters['order_id'] = id;
            } else {
                filters['id'] = id;
            }
            console.log("filters['id']");
            console.log(filters['id']);

            try {
                const response = await fetch(`/crud/${entityType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(filters),
                });

                // Fetch the entity data from the backend using the entityId
                // const response = await fetch(`/${entityType}/${id}`);
                const entity = await response.json();
                const entityData = entity[0];
                console.log("entityData", entityData);

                // Load schema again and render the edit form dynamically
                loadSchema(entityType).then(schema => {
                    schema.fields.forEach(field => {
                        console.log("field", field);

                        if (!field.editable) return;  // Skip non-editable fields

                        // Ensure the field exists in entityData
                        if (!(field.name in entityData)) {
                            if (field.name == "currency_id" && 'symbol' in entityData) {
                                entityData['currency_id'] = entityData['symbol'];
                            } else if (field.name == "country_code_id" && 'code' in entityData) {
                                entityData['country_code_id'] = entityData['code'];
                            } else if (field.name == 'id' && 'order_id' in entityData && entityType == 'orders') {
                                entityData['order_id'] = entityData['order_id'];
                            } else {
                                console.warn(`Field ${field.name} does not exist in entityData`);
                                return;
                            }
                        }

                        console.log("entityData BEFORE INPUT", entityData);
                        let input;

                        if (field.name === 'id' || field.name == 'order_id') {
                            input = document.createElement('input');
                            input.type = 'hidden';  // Hide the ID field
                            input.value = entityData[field.name];  // Pre-fill with the entity data
                            console.log("ENTITY ID TO EDIT");
                            console.log(entityData[field.name]);
                            input.name = field.name;  // Still give it a name for submission

                            // Append the hidden ID field directly to the form without a label
                            editForm.appendChild(input);
                            return;
                        }

                        const formGroup = document.createElement('div');
                        formGroup.className = 'form-group';

                        const label = document.createElement('label');
                        label.textContent = field.label;
                        formGroup.appendChild(label);

                        if (field.type === 'multiselect' && Array.isArray(entityData[field.name])) {
                            console.log("CATEGORIES IF");

                            input = document.createElement('select');
                            input.className = 'form-control';
                            input.name = field.name;
                            input.multiple = true;

                            // Fetch options and mark selected ones
                            fetch(field.options_url)
                                .then(response => response.json())
                                .then(options => {
                                    options.forEach(option => {
                                        const opt = document.createElement('option');
                                        opt.value = option.id;
                                        opt.textContent = option.name;
                                        if (entityData[field.name].includes(option.name)) {
                                            opt.selected = true;  // Pre-select categories that the product already has
                                        }
                                        input.appendChild(opt);
                                        formGroup.appendChild(input);
                                    });
                                })
                                .catch(error => {
                                    console.error(`Error loading ${field.name} options:`, error);
                                });
                        } else if (field.name === 'images' && Array.isArray(entityData[field.name])) {

                            // Handle the array of images
                            const images = entityData[field.name];  // Array of image paths

                            // Iterate through each image and create its preview along with remove option
                            images.forEach((imagePath, index) => {
                                if (!imagePath) return;  // Ensure imagePath is valid

                                const imageWrapper = document.createElement('div');
                                imageWrapper.className = 'image-wrapper';

                                const imagePreview = document.createElement('img');
                                imagePreview.className = 'form-image';
                                imagePreview.src = `/${imagePath}`;
                                imagePreview.alt = 'Image Preview';
                                imagePreview.style.maxWidth = '150px';
                                imagePreview.style.height = 'auto';

                                // Create a checkbox to allow image removal
                                const removeCheckbox = document.createElement('input');
                                removeCheckbox.type = 'checkbox';
                                removeCheckbox.name = `remove_image_${index}`;  // Unique name for each image
                                removeCheckbox.value = imagePath;  // Use the image path as value

                                const removeLabel = document.createElement('label');
                                removeLabel.textContent = 'Remove Image';

                                // Append image preview and remove option to the wrapper
                                imageWrapper.appendChild(imagePreview);
                                imageWrapper.appendChild(removeCheckbox);
                                imageWrapper.appendChild(removeLabel);

                                // Append the entire wrapper to the form group
                                formGroup.appendChild(imageWrapper);
                            });

                            // Allow new image upload
                            const newImageInput = document.createElement('input');
                            newImageInput.type = 'file';
                            newImageInput.name = 'new_images';
                            newImageInput.multiple = true; 
                            formGroup.appendChild(newImageInput);
                        } else if (field.type === 'select') {
                            input = document.createElement('select');
                            input.className = 'form-control';
                            input.name = field.name;

                            // Fetch options from the server for the select field
                            fetch(field.options_url)
                                .then(response => response.json())
                                .then(options => {
                                    options.forEach(option => {
                                        console.log("option", option);
                                        const opt = document.createElement('option');
                                        if (option.param == undefined) {
                                            opt.value = option.name;  // or option.id
                                            opt.textContent = option.name;
                                            if (option.symbol === entityData[field.name]) {
                                                opt.selected = true;
                                            }
                                        } else {
                                            opt.value = option.id;  // or option.id
                                            opt.textContent = option.name + " ( " + option.param + " ) ";
                                            if (option.name === entityData[field.name]) {
                                                opt.selected = true;
                                            }
                                        }
                                        input.appendChild(opt);
                                    });
                                })
                                .catch(error => {
                                    console.error(`Error loading ${field.name} options:`, error);
                                });
                            formGroup.appendChild(input);
                        } else if (field.type === 'number' || field.type === 'integer') {
                            input = document.createElement('input');
                            input.type = 'number';
                            input.value = entityData[field.name];
                            input.className = 'form-control';
                            input.name = field.name;
                            formGroup.appendChild(input);
                        } else if (field.type === 'boolean') {
                            input = document.createElement('input');
                            input.type = 'checkbox';
                            input.checked = entityData[field.name];  // Set checkbox value
                            input.className = 'form-control';
                            input.name = field.name;
                            formGroup.appendChild(input);
                        }else if (field.type === 'date') { 
                            input = document.createElement('input');
                            input.type = 'datetime-local';

                            const isoDateTime = entityData[field.name];
                            const dateTimeWithoutSeconds = isoDateTime ? isoDateTime.slice(0, 16) : ''; // Extract "YYYY-MM-DDTHH:MM" portion
                            input.value = dateTimeWithoutSeconds;

                            input.name = field.name; // 'date-create'
                            input.className = 'form-control';
                            formGroup.appendChild(input);
                        } else {
                            input = document.createElement('input');
                            input.type = 'text';
                            input.value = entityData[field.name];  // Pre-fill with entity data
                            input.className = 'form-control';
                            input.name = field.name;
                            formGroup.appendChild(input);
                        }

                        editForm.appendChild(formGroup);
                    });
                    // Parse the order_items string into individual items
            if (entityData.order_items) {
                const orderItemsString = entityData.order_items.replace(/^\{/, "[").replace(/\}$/, "]");
                console.log("orderItemsString");
                console.log(orderItemsString);

                const formattedOrderItems = orderItemsString.replace(/\((\d+),(\d+),([\d.]+)\)/g, '[$1, $2, $3]');
                console.log("formattedOrderItems");
                console.log(formattedOrderItems);

                const orderItemsStr = JSON.parse(formattedOrderItems);
                console.log("orderItemsStr");
                console.log(orderItemsStr);

                const orderItems = orderItemsStr.map(item => JSON.parse(item));
                console.log("orderItems");
                console.log(orderItems);

                // Create the table element
                const table = document.createElement('table');
                table.className = 'table table-bordered';

                // Create the table header row
                const headerRow = document.createElement('tr');
                const headers = ['Product ID', 'Quantity', 'Price'];

                headers.forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });
                table.appendChild(headerRow);

                orderItems.forEach((item, index) => {
                    const [productId, quantity, price] = item;
                    console.log("item", item);
                    console.log("productId", productId);
                    console.log("quantity", quantity);
                    console.log("price", price);

                    // Create a new row for each product
                    const row = document.createElement('tr');

                    // Product ID cell
                    const productIdCell = document.createElement('td');
                    const productIdInput = document.createElement('input');
                    productIdInput.type = 'number';
                    productIdInput.className = 'form-control';
                    productIdInput.name = `order_items[${index}][product_id]`;
                    productIdInput.value = productId;
                    productIdInput.readOnly = true;  // Make Product ID read-only
                    productIdCell.appendChild(productIdInput);
                    row.appendChild(productIdCell);

                    // Quantity cell
                    const quantityCell = document.createElement('td');
                    const quantityInput = document.createElement('input');
                    quantityInput.type = 'number';
                    quantityInput.className = 'form-control';
                    quantityInput.name = `order_items[${index}][quantity]`;
                    quantityInput.value = quantity;
                    quantityCell.appendChild(quantityInput);
                    row.appendChild(quantityCell);

                    // Price cell
                    const priceCell = document.createElement('td');
                    const priceInput = document.createElement('input');
                    priceInput.type = 'number';
                    priceInput.className = 'form-control';
                    priceInput.name = `order_items[${index}][price]`;
                    priceInput.value = price;
                    priceCell.appendChild(priceInput);
                    row.appendChild(priceCell);

                    // Append the row to the table
                    table.appendChild(row);
                });
                editForm.appendChild(table);
            }
                    // Open the modal
                    $('#editModal').modal('show');
                });
            } catch (error) {
                console.error('Error fetching entity data:', error);
                alert('Failed to load entity data for editing');
            }
        }


        // Save Edit button in modal
        document.getElementById('save-edit-btn').addEventListener('click', async function() {
            const formData = new FormData(document.getElementById('edit-form'));
            const updatedData = {};
            const orderItems = {};

            console.log("formData");
            console.log(formData);

            formData.forEach((value, key) => {
                if (key === 'categories') {
                    if (!updatedData[key]) {
                        updatedData[key] = [];
                    }
                    updatedData[key].push(value);  // Push all selected categories into an array
                } else if (key.startsWith('order_items')) {
                    // Match pattern: order_items[index][field]
                    const match = key.match(/^order_items\[(\d+)]\[(\w+)]$/);
                    if (match) {
                        const index = match[1];
                        const field = match[2];
                        
                        // Initialize an object for each order item index
                        if (!orderItems[index]) {
                            orderItems[index] = {};
                        }
                        
                        // Assign the value to the appropriate field
                        orderItems[index][field] = value;
                    }
                } else {
                    updatedData[key] = value;  // For non-categories fields, store as usual
                }
            });

            // Convert the orderItems object to an array of objects and add to updatedData
            updatedData['order_items'] = Object.values(orderItems);

            formData.append('order_items', JSON.stringify(updatedData['order_items']));

            console.log("updatedData");
            console.log(updatedData);
            console.log("formData['order_items']");
            console.log(formData.order_items);

            // Handle removed images (checkboxes that were checked)
            const removedImages = [];
            document.querySelectorAll('input[name^="remove_image_"]:checked').forEach(checkbox => {
                removedImages.push(checkbox.value);  // Add the image path to the removedImages array
            });

            updatedData['removedImages'] = removedImages;

            console.log("Updated data:", updatedData);
            console.log("formData data:", formData);

            let entityToUpdateId;
            if (entityType == 'orders') {
                entityToUpdateId = updatedData.order_id
            } else {
                entityToUpdateId = updatedData.id
            }
            console.log("entityToUpdateId");
            console.log(entityToUpdateId);

            try {
                const response = await fetch(`/update/${entityType}/${entityToUpdateId}`, {
                    method: 'PUT',  
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.log("errorData");
                    console.log(errorData);
                    throw new Error(errorData.error_message);
                }

                const result = await response.json();
                alert(result.message);

                // Close the modal after saving
                $('#editModal').modal('hide');
            } catch (error) {
                alert(error)
                console.error('Error saving changes:', error);
            }
        });

        // Delete Entity function
        async function deleteEntity(entityId) {
            if (confirm('Are you sure you want to delete this entity?')) {
                try {
                    const response = await fetch(`/api/${entityType}/${entityId}`, {
                        method: 'DELETE',
                    });
                    const result = await response.json();
                    alert(result.message);
                    handleSubmit();  // Refresh the product list after deletion
                } catch (error) {
                    console.error('Error deleting entity:', error);
                }
            }
        }

        document.getElementById('create-product-btn').addEventListener('click', function() {
            loadSchema(entityType).then(schema => {
                renderCreateProductForm(schema);
                $('#createProductModal').modal('show');  // Open the modal
            });
        });

        // Function to render the Create Product form based on the schema
        function renderCreateProductForm(schema) {
            const createForm = document.getElementById('create-product-form');
            createForm.innerHTML = '';

            schema.fields.forEach(field => {
                if (!field.create) return; 

                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = field.label;
                formGroup.appendChild(label);

                let input;

                if (field.name === 'email' && field.paginated) {
                    input = document.createElement('select');
                    input.id = 'email-dropdown';
                    input.className = 'form-control';
                    input.name = field.name;
                    input.size = 5;
                    input.style.overflowY = 'scroll';

                    input.dataset.optionsUrl = field.options_url;
                    input.dataset.pageSize = field.page_size || 20;

                    loadMoreOptions(input, field.options_url, field.page_size || 20);

                    input.addEventListener('scroll', onScrollLoadMore);
                    formGroup.appendChild(input);

                } else if (field.name === 'order_items' && field.paginated) {
                    const table = document.createElement('table');
                    table.className = 'table table-bordered table-hover';
                    const tableBody = document.createElement('tbody');
                    table.appendChild(tableBody);

                    // Infinite scroll container for the table
                    const scrollContainer = document.createElement('div');
                    scrollContainer.id = 'order-items-container';
                    scrollContainer.style.height = '300px';
                    scrollContainer.style.overflowY = 'auto';
                    scrollContainer.appendChild(table);
                    scrollContainer.dataset.optionsUrl = field.options_url;
                    scrollContainer.dataset.pageSize = field.page_size || 20;

                    loadMoreProducts(tableBody, field.options_url, field.page_size || 20);

                    scrollContainer.addEventListener('scroll', onScrollLoadMoreProducts);

                    formGroup.appendChild(scrollContainer);

                    const selectedProductsContainer = document.createElement('div');
                    selectedProductsContainer.id = 'selected-products-container';
                    selectedProductsContainer.className = 'mt-3';
                    formGroup.appendChild(selectedProductsContainer);
                } else if (field.type === 'multiselect') {
                    input = document.createElement('select');
                    input.className = 'form-control';
                    input.name = field.name;
                    input.multiple = true;

                    // Fetch options for categories or other multiselect fields
                    fetch(field.options_url)
                        .then(response => response.json())
                        .then(options => {
                            options.forEach(option => {
                                const opt = document.createElement('option');
                                opt.value = option.id;  // Assuming categories or currencies
                                opt.textContent = option.name;
                                input.appendChild(opt);
                            });
                        })
                        .catch(error => {
                            console.error(`Error loading ${field.name} options:`, error);
                        });
                    formGroup.appendChild(input);
                } else if (field.type === 'array' && field.item_type === 'image') {
                    input = document.createElement('input');
                    input.type = 'file';
                    input.className = 'form-control';
                    input.name = field.name;  // Use the field name for submission
                    input.multiple = true;  // Allow multiple image uploads
                    formGroup.appendChild(input);
                } else if (field.type === 'select') {
                    input = document.createElement('select');
                    input.className = 'form-control';
                    input.name = field.name;

                    // Fetch options for the select field (like currency)
                    fetch(field.options_url)
                        .then(response => response.json())
                        .then(options => {
                            options.forEach(option => {
                                if (Object.keys(option).length == 1) {
                                    const opt = document.createElement('option');
                                    opt.value = option.name;
                                    opt.textContent = option.name;
                                    input.appendChild(opt);
                                } else if (Object.keys(option).length == 2) {
                                    const opt = document.createElement('option');
                                    opt.value = option.name;
                                    opt.textContent = option.name + " (" + option.param + ")";
                                    input.appendChild(opt);
                                } else if (Object.keys(option).length == 3) {
                                    const opt = document.createElement('option');
                                    opt.value = parseInt(option.id);
                                    opt.textContent = option.name + " (" + option.param + ")";
                                    input.appendChild(opt);
                                }
                            });
                        })
                        .catch(error => {
                            console.error(`Error loading ${field.name} options:`, error);
                        });
                    formGroup.appendChild(input);
                } else if (field.type === 'number' || field.type === 'integer') {
                    input = document.createElement('input');
                    input.type = 'number';
                    input.name = field.name;
                    input.className = 'form-control';
                    formGroup.appendChild(input);
                } else if (field.type === 'boolean') {
                    input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'form-control';
                    formGroup.appendChild(input);
                } else if (field.type === 'date') { 
                    input = document.createElement('input');
                    input.type = 'datetime-local';
                    input.name = 'date-create';
                    input.className = 'form-control';
                    formGroup.appendChild(input);
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.name = field.name;
                    input.className = 'form-control';
                    formGroup.appendChild(input);
                }

                // input.className = 'form-control';
                // formGroup.appendChild(input);

                // errors for each field
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message text-danger';
                errorDiv.style.display = 'none';
                formGroup.appendChild(errorDiv);

                createForm.appendChild(formGroup);
            });
        }

        document.getElementById('save-create-product-btn').addEventListener('click', async function() {
            document.querySelectorAll('.error-message').forEach(div => {
                div.style.display = 'none';
                div.textContent = '';
            });

            const formData = new FormData(document.getElementById('create-product-form'));

            console.log("formData");
            console.log(formData);

            const productData = Object.fromEntries(formData.entries());

            console.log("productData");
            console.log(productData);

            console.log("entityType");
            console.log(entityType);

            if (entityType == 'products') {
                // Convert formData to an object (handling arrays like categories and images)
                productData.categories = formData.getAll('categories'); // Handle multiselect categories
                productData.images = formData.getAll('images'); // Handle multiple images
                console.log("productData.images");
                console.log(productData.images);
                productData.price = parseFloat(productData.price);
                productData.quantity = parseInt(productData.quantity);
                const imageConstraints = currentSchema.properties.images.fileConstraints;
                const validExtensions = imageConstraints.validExtensions;
                const maxSizeInBytes = imageConstraints.maxSize;

                const images = formData.getAll('images');
                for (const file of images) {
                    if (!validExtensions.some(ext => file.name.toLowerCase().endsWith(ext))) {
                        alert(`Invalid file type: ${file.name}. Only JPG and PNG files are allowed.`);
                        return;
                    }
                    if (file.size > maxSizeInBytes) {
                        alert(`File too large: ${file.name}. Maximum size allowed is 5 MB.`);
                        return;
                    }
                }

                formData.delete('categories');
                productData.categories.forEach(category => {
                    formData.append('categories', parseInt(category));
                });
            } else if (entityType == 'users') {
                productData.country_code_id = parseInt(productData.country_code_id);
                productData.verification_status = formData.has('verification_status');
                formData.append('country_code_id', productData.country_code_id);
                formData.append('verification_status', productData.verification_status);
            } else if (entityType == 'orders') {
                const productsArray = [];
                selectedProducts.forEach((product, productId) => {
                    // form-control quantity-input
                    const quantityInput = document.querySelector(`input.quantity-input[data-product-id="${productId}"]`);
                    console.log("quantityInput  FOR THE PRODUCT" + quantityInput);
                    const quantity = quantityInput ? parseInt(quantityInput.value, 10) : 1;

                    productsArray.push({
                        product_id: productId,
                        // name: product.name,
                        price: product.price,
                        quantity: quantity,
                        // total_price: product.price * quantity,
                        // currency: product.symbol,
                        vat: product.vat
                    });
                });

                console.log("PRODUCTS GIVEN TO THE BACK END");
                console.log(productsArray);

                formData.append('order_items', JSON.stringify(productsArray));
                productData.selected_products =  JSON.stringify(productsArray);

                const dateInput = document.querySelector('input[name="date-create"]');
                console.log("dateInput");
                console.log(dateInput);
                if (dateInput && dateInput.value) {
                    formData.append('order_date', dateInput.value);
                    productData.order_date = dateInput.value;
                }
                delete productData['date-create'];
                formData.delete('date-create');

            }

            console.log("productData AFTER HOOK");
            console.log(productData);
            console.log("formData AFTER HOOK");
            console.log(formData);

            const isValidData = validate(productData);

            console.log(validate.errors);
            console.log("isValidData");
            console.log(isValidData);

            if (!isValidData) {
                // For each validation error, find the corresponding error container
                validate.errors.forEach(err => {
                    console.log("err");
                    console.log(err);
                    const fieldName = err.instancePath.slice(1);
                    const inputElement = document.querySelector(`[name="${fieldName}"]`);

                    console.log("inputElement");
                    console.log(inputElement);

                    if (inputElement) {
                        const errorDiv = inputElement.closest('.form-group').querySelector('.error-message');

                        console.log("errorDiv");
                        console.log(errorDiv);

                        if (errorDiv) {
                            errorDiv.style.display = 'block';
                            errorDiv.textContent = err.message;
                        }
                    } else {
                        console.warn(`No input element found for field "${fieldName}"`);
                    }
                });
                return;
            }

            try {
                const response = await fetch(`/create/${entityType}`, {
                    method: 'POST',
                    body: formData,
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.log("errorData");
                    console.log(errorData);
                    // alert(errorData.error_message);
                    throw new Error(errorData.error_message);
                }

                const result = await response.json();
                alert(result.message);
                // Close the modal after creation
                $('#createProductModal').modal('hide');
            } catch (error) {
                console.log("ERROR WHEN CREATING ENTITY");
                console.log("error");
                console.log(error);
                console.log(alert(error));
            }
        });

        $('#createProductModal').on('hidden.bs.modal', () => {
            selectedProducts.clear();
            console.log("selectedProducts cleared:", selectedProducts);
        });

        document.getElementById('submit-btn').addEventListener('click', handleSubmit);

        // Load and render form on page load
        loadSchema(entityType).then(schema => {
            if (schema) renderForm(schema);
        });

        async function fetchOrderItems(orderId, cell) {
            try {
                cell.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div>';

                const response = await fetch(`/order_items?order_id=${orderId}`);

                console.log("response");
                console.log(response);

                const orderItems = await response.json();

                console.log("orderItems.data");
                console.log(orderItems.data);

                cell.innerHTML = ''; 
                if (orderItems.data.length === 0) {
                    cell.innerHTML = 'No items found for this order';
                    return;
                }

                const currentRow = cell.closest('tr');

                const newRow = document.createElement('tr');
                const newCell = document.createElement('td');
                newCell.colSpan = currentRow.cells.length;

                const collapsibleDiv = document.createElement('div');
                collapsibleDiv.className = 'collapse';

                const table = document.createElement('table');
                table.className = 'table table-sm table-bordered';

                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th class="text-center">Product ID</th>
                        <th class="text-center">Product Name</th>
                        <th class="text-center">Quantity</th>
                        <th class="text-center">Price</th>
                        <th class="text-center">Currency</th>
                    </tr>
                `;
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                orderItems.data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="text-right">${item.product_id}</td>
                        <td class="text-right">${item.product_name}</td>
                        <td class="text-right">${item.quantity}</td>
                        <td class="text-right">${item.price}</td>
                        <td class="text-right">${item.currency_symbol}</td>
                    `;
                    tbody.appendChild(row);
                });
                table.appendChild(tbody);

                collapsibleDiv.appendChild(table);
                newCell.appendChild(collapsibleDiv);
                newRow.appendChild(newCell);

                currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);

                // const collapsibleDiv = document.createElement('div');
                // collapsibleDiv.className = 'collapse';
                // collapsibleDiv.appendChild(table);

                const toggleButton = document.createElement('button');
                toggleButton.className = 'btn btn-link p-0';
                toggleButton.textContent = 'Show Items';
                toggleButton.onclick = () => {
                    const isCollapsed = collapsibleDiv.classList.toggle('show');
                    toggleButton.textContent = isCollapsed ? 'Hide Items' : 'Show Items';
                };

                cell.appendChild(toggleButton);
                // cell.appendChild(collapsibleDiv);
            } catch (error) {
                console.error('Error fetching order items:', error);
            }
        }

        function showLoadingSpinner() {
            document.getElementById('loading-overlay').classList.remove('d-none');
        }

        function hideLoadingSpinner() {
            document.getElementById('loading-overlay').classList.add('d-none');
        }

        let currentPage = 0;

        async function loadMoreOptions(selectElement, url, pageSize) {
            currentPage += 1;
            const fetchUrl = `${url}?page=${currentPage}&page_size=${pageSize}`;

            try {
                const response = await fetch(fetchUrl);
                const options = await response.json();

                console.log("options");
                console.log(options);

                options.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option.email;
                    opt.textContent = option.email;
                    selectElement.appendChild(opt);
                });

                if (options.length < pageSize) {
                    selectElement.removeEventListener('scroll', loadMoreOptions);
                }
            } catch (error) {
                console.error(`Error loading options for dropdown: ${error}`);
            }
        }

        function onScrollLoadMore(event) {
            const selectElement = event.target;

            if (selectElement.scrollTop + selectElement.clientHeight >= selectElement.scrollHeight - 10) {
                loadMoreOptions(selectElement, selectElement.dataset.optionsUrl, parseInt(selectElement.dataset.pageSize, 10));
            }
        }

        let currentProductPage = 0;
        let selectedProducts = new Map();

        async function loadMoreProducts(tableBody, url, pageSize) {
            currentProductPage += 1;
            const fetchUrl = `${url}?page=${currentProductPage}&page_size=${pageSize}`;

            try {
                const response = await fetch(fetchUrl);
                const products = await response.json();

                console.log("products");
                console.log(products);

                products.forEach(product => {
                    const row = document.createElement('tr');

                    // Checkbox for selection
                    const checkboxCell = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = product.id;

                    checkbox.addEventListener('change', (event) => {
                        if (event.target.checked) {
                            selectedProducts.set(product.id, product);
                        } else {
                            selectedProducts.delete(product.id);
                        }
                        updateSelectedProductsDisplay();
                    });

                    checkboxCell.appendChild(checkbox);
                    row.appendChild(checkboxCell);

                    // Product Details
                    const idCell = document.createElement('td');
                    idCell.textContent = product.id;
                    row.appendChild(idCell);

                    const nameCell = document.createElement('td');
                    nameCell.textContent = product.name;
                    row.appendChild(nameCell);

                    const priceCell = document.createElement('td');
                    priceCell.textContent = product.price;
                    row.appendChild(priceCell);

                    const symbolCell = document.createElement('td');
                    symbolCell.textContent = product.symbol;
                    row.appendChild(symbolCell);

                    // const vatCell = document.createElement('td');
                    // vatCell.textContent = product.vat;
                    // row.appendChild(vatCell);

                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error(`Error loading products: ${error}`);
            }
        }

        function onScrollLoadMoreProducts(event) {
            const container = event.target;

            if (container.scrollTop + container.clientHeight >= container.scrollHeight - 10) {
                const tableBody = container.querySelector('tbody');
                const url = container.dataset.optionsUrl;
                const pageSize = parseInt(container.dataset.pageSize, 10);

                loadMoreProducts(tableBody, url, pageSize);
            }
        }

        function updateSelectedProductsDisplay() {
            const container = document.getElementById('selected-products-container');
            container.innerHTML = '';

            if (selectedProducts.size === 0) {
                container.textContent = 'No products selected';
                return;
            }

            const table = document.createElement('table');
            table.className = 'table table-bordered';
            const headerRow = document.createElement('tr');

            ['ID', 'Name', 'Price', 'Currency', 'Quantity', 'Total Price'].forEach(headerText => {
                const header = document.createElement('th');
                header.textContent = headerText;
                headerRow.appendChild(header);
            });
            table.appendChild(headerRow);

            selectedProducts.forEach(product => {
                const row = document.createElement('tr');

                const idCell = document.createElement('td');
                idCell.textContent = product.id;
                row.appendChild(idCell);

                const nameCell = document.createElement('td');
                nameCell.textContent = product.name;
                row.appendChild(nameCell);

                const priceCell = document.createElement('td');
                priceCell.textContent = product.price;
                row.appendChild(priceCell);

                const symbolCell = document.createElement('td');
                symbolCell.textContent = product.symbol;
                row.appendChild(symbolCell);

                // Quantity Cell (editable input)
                const quantityCell = document.createElement('td');
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.value = 1;
                quantityInput.min = 1;
                quantityInput.className = 'form-control quantity-input';
                quantityInput.setAttribute('data-product-id', product.id); 
                quantityCell.appendChild(quantityInput);
                row.appendChild(quantityCell);

                const totalPriceCell = document.createElement('td');
                totalPriceCell.className = 'total-price-cell';
                const initialTotalPrice = product.price * parseInt(quantityInput.value, 10);
                totalPriceCell.textContent = `${initialTotalPrice} ${product.symbol}`;
                row.appendChild(totalPriceCell);

                // const vatCell = document.createElement('td');
                // vatCell.textContent = product.vat;
                // row.appendChild(vatCell);

                quantityInput.addEventListener('input', () => {
                    const quantity = parseInt(quantityInput.value, 10);
                    const totalPrice = product.price * quantity;
                    totalPriceCell.textContent = `${totalPrice.toFixed(2)} ${product.symbol}`;
                });

                table.appendChild(row);
            });

            container.appendChild(table);
    }
    </script>
</body>
</html>
